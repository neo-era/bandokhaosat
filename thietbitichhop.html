<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web GIS with Location Tracking and Save to Excel</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.2.0/dist/exceljs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 80%;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        #controls input, #controls button {
            padding: 5px;
            margin-right: 5px;
        }
        #notification {
            position: absolute;
            top: 50px;
            left: 10px;
            z-index: 1001;
            background: #28a745;
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .popup-content input {
            width: 100%;
            margin-bottom: 5px;
        }
        .popup-content label {
            font-weight: bold;
        }
        #imagePreview {
            max-width: 100%;
            display: none;
        }
        .icon-custom {
            width: 24px;
            height: 24px;
        }
        #markerList {
            position: absolute;
            top: 100px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            max-height: 300px;
            overflow-y: auto;
        }
        #markerList div {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

<div id="controls">
    <input type="text" id="locationInput" placeholder="Enter a location">
    <button onclick="searchLocation()">Search</button>
    <button onclick="trackLocation()">Track My Location</button>
    <button onclick="saveLocation()">Save Location to Excel</button>
    <button onclick="locateUser()">Locate Me</button>
    <button onclick="saveLocationsToExcel()">Download All Locations</button>
    <input type="file" id="fileInput" accept=".xlsx" onchange="loadLocationsFromExcel(event)">
    <button onclick="clearMarkers()">Clear Markers</button>
</div>

<div id="notification">Location has been saved to Excel!</div>
<div id="error"></div>
<div id="map"></div>
<div id="markerList"></div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.2.0/dist/exceljs.min.js"></script>
<script>
    // Define different basemaps
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    });

    var satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 19,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: '© Google Maps'
    });

    var terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17,
        attribution: '© OpenTopoMap contributors'
    });

    // Initialize the map and set its view to a starting point and zoom level
    var map = L.map('map', {
        center: [10.762622, 106.660172],  // Default location: Ho Chi Minh City, Vietnam
        zoom: 15,
        layers: [osm]  // Set default layer
    });

    // Create a layer control and add it to the map
    var baseMaps = {
        "OpenStreetMap": osm,
        "Satellite": satellite,
        "Terrain": terrain
    };

    L.control.layers(baseMaps).addTo(map);

    // Define custom icons for different types of markers
    const iconUrls = {
        type1: 'https://example.com/icon1.png', // Replace with your icon URLs
        type2: 'https://example.com/icon2.png',
        type3: 'https://example.com/icon3.png',
        type4: 'https://example.com/icon4.png',
        type5: 'https://example.com/icon5.png',
        type6: 'https://example.com/icon6.png'
    };

    // Function to search for a location
    function searchLocation() {
        var location = document.getElementById('locationInput').value;
        // Implement search functionality here
    }

    // Function to track user's location
    function trackLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                var marker = L.marker([lat, lng]).addTo(map);
                map.setView([lat, lng], 15);
                // Save location to Excel
                saveLocationToExcel(lat, lng);
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    // Function to save location to Excel
    function saveLocationToExcel(lat, lng) {
        var workbook = new ExcelJS.Workbook();
        var worksheet = workbook.addWorksheet('Locations');
        worksheet.columns = [
            { header: 'Latitude', key: 'lat' },
            { header: 'Longitude', key: 'lng' }
        ];
        worksheet.addRow({ lat: lat, lng: lng });
        workbook.xlsx.writeBuffer().then(function(data) {
            var blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'locations.xlsx';
            a.click();
            window.URL.revokeObjectURL(url);
            document.getElementById('notification').style.display = 'block';
            setTimeout(function() {
                document.getElementById('notification').style.display = 'none';
            }, 3000);
        });
    }

    // Function to locate user
    function locateUser() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                map.setView([lat, lng], 15);
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    // Function to save all locations to Excel
    function saveLocationsToExcel() {
        // Implement functionality to save all locations to Excel
    }

    // Function to load locations from Excel
    function loadLocationsFromExcel(event) {
        var file = event.target.files[0];
        var reader = new FileReader();
        reader.onload = function(e) {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, { type: 'array' });
            var sheet = workbook.Sheets[workbook.SheetNames[0]];
            var rows = XLSX.utils.sheet_to_json(sheet);
            var markerList = document.getElementById('markerList');
            markerList.innerHTML = ''; // Clear previous list

            rows.forEach(function(row, index) {
                var lat = row.Latitude;
                var lng = row.Longitude;
                var marker = L.marker([lat, lng]).addTo(map);

                // Add marker to the list
                var listItem = document.createElement('div');
                listItem.innerHTML = `Marker ${index + 1}: Latitude: ${lat}, Longitude: ${lng}`;
                markerList.appendChild(listItem);
            });
        };
        reader.readAsArrayBuffer(file);
    }

    // Function to clear all markers
    function clearMarkers() {
        // Implement functionality to clear all markers
    }
</script>

</body>
</html>
